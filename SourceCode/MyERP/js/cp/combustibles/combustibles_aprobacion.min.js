"use strict";let date=new Date,descargas="AprobacionCombustible_"+date.getFullYear()+"_"+date.getMonth()+"_"+date.getUTCDay()+"_"+date.getMilliseconds(),pagina="82",solicitud={idSolicitud:-1,idUsuario:-1,solicitud:{},arrayData:[],accion:"",idSeleccionado:-1};class SolicitudCombustible{constructor(n){this.IdRegistroFalla=n;this.IdEquipo=null;this.FechaCreacion=null}}const registroAprobacion={init:()=>{$("#panelTabla").show(),$("#panelForm").hide(),registroAprobacion.idSeleccionado=-1,registroAprobacion.idSolicitud=-1,registroAprobacion.idDetalleSolicitud=-1,registroAprobacion.idDetalleSeleccionado=-1,registroAprobacion.idTipoSolicitud=-1,registroAprobacion.accion="",registroAprobacion.cargarComboProveedoresCombustible(),registroAprobacion.cargarItems(),registroAprobacion.fecha=""},cargarComboProveedoresCombustible:()=>{let n={};n.path=window.location.hostname;n=JSON.stringify(n);$.ajax({type:"POST",url:"../pages/Combustibles_Aprobacion.aspx/GetListaProveedoresCombustible",data:n,contentType:"application/json; charset=utf-8",dataType:"json","async":!0,success:function(n){let t=n.d,i=`<option value="0">Seleccione...</option>`;for(let n=0;n<t.length;n++){let r=t[n];i+=`<option value="${r.IdProveedor}">${r.Nombre}</option>`}$("#comboProveedorCombustible").empty().append(i)},error:function(n,t){console.log(t+": "+n.responseText)}})},cargarItems:()=>{var n={};n.path=window.location.hostname;n.idUsuario=sessionStorage.getItem("idusuario");utils.postData("../pages/Combustibles_Aprobacion.aspx/GetListaItems",n).then(n=>{n=n.d;let t=$("#table").DataTable({destroy:!0,processing:!0,order:[],data:n,columns:[{data:"IdSolicitud"},{data:"FechaFormateadaMx"},{data:"NombreUsuarioSolicita"},{data:"NombreStatus"},{data:"Accion"}],language:textosEsp,columnDefs:[{targets:[0,1,2,3],orderable:!1},],dom:"fBrtipl",buttons:[{extend:"csvHtml5",title:descargas,text:"&nbsp;Exportar Csv",className:"csvbtn"},{extend:"excelHtml5",title:descargas,text:"Xls",className:"excelbtn"},{extend:"pdfHtml5",title:descargas,text:"Pdf",className:"pdfbtn"}]})})},eliminar:n=>{registroAprobacion.idSeleccionado=n,$("#panelEliminar").modal("show")},cancelar:(n,t)=>{registroAprobacion.idSolicitud=n,registroAprobacion.idDetalleSeleccionado=t,$("#msgCancelarSolicitud").html("Se marcará como cancelada la solicitud de combustible seleccionada (No."+t+"). ¿Desea continuar?"),$("#panelCancelar").modal("show")},finalizar:n=>{registroAprobacion.idSeleccionado=n,$("#msgFinalizar").html("Se dará por concluida esta solicitud y se envía a histórico (No."+n+"). ¿Desea continuar?"),$("#panelFinalizar").modal("show")},finalizarSolicitudIndividual:(n,t)=>{console.log("finalizarSolicitudIndividual"),registroAprobacion.idSolicitud=n,registroAprobacion.idDetalleSeleccionado=t,$("#msgFinalizarIndividual").html("Se dará por concluida esta solicitud individual y se envía a histórico (No."+t+"). ¿Desea continuar?"),$("#panelFinalizarIndividual").modal("show")},aprobarSolicitudIndividual:(n,t,i)=>{console.log("aprobarSolicitudIndividual");$("#comboProveedorCombustible").val(0);const f=$("#tableSolicitudes tbody tr").length;let r=0,u=0;for(let n=0;n<f;n++){let i=$(`#txtLitros${n}`).attr("data-iddetalle");Number(i)===Number(t)&&(r=$(`#txtOrometro${n}`).val()!=null?$(`#txtOrometro${n}`).val():"0",u=$(`#txtLitros${n}`).val()!=null?$(`#txtLitros${n}`).val():"0")}if(r===0||r===""||Number(r)<1){$("#spnMensajes").html(mensajesAlertas.errorSolicitudesCombustibleOrometroAprobacion);$("#panelMensajes").modal("show");return}if(u===0||u===""||Number(u)<1){$("#spnMensajes").html(mensajesAlertas.errorSolicitudesCombustibleLitrosAprobacion);$("#panelMensajes").modal("show");return}registroAprobacion.idSolicitud=n;registroAprobacion.idDetalleSolicitud=t;registroAprobacion.idTipoSolicitud=i;registroAprobacion.data={odometro:r,litros:u};registroAprobacion.idSolicitud=n;registroAprobacion.idDetalleSolicitud=t;registroAprobacion.data={odometro:r,litros:u};i===2?($("#msgAprobarIndividual").html("Se marcará como aprobada la solicitud de combustible seleccionada (No."+t+"). ¿Desea continuar?"),$("#panelAprobarIndividuales").modal("show")):($("#msgAprobar").html("Se marcará como aprobada la solicitud de combustible seleccionada (No."+t+"). ¿Desea continuar?"),$("#panelAprobarGeneral").modal("show"))},editarDetalle:n=>{$(".form-group").removeClass("has-error");$(".help-block").empty();$("#panelTabla").hide();$("#panelForm").show();registroAprobacion.accion="editar";registroAprobacion.idSeleccionado=n;registroAprobacion.idEquipoSeleccionado=-1;$(".deshabilitable").prop("disabled",!1);$("#tableSolicitudes tbody").empty();var t={};t.path=window.location.hostname;t.idSolicitud=n;t.modo="edicion";t.status=2;t=JSON.stringify(t);$.ajax({type:"POST",url:"../pages/Combustibles_Aprobacion.aspx/AbrirSolicitud",data:t,contentType:"application/json; charset=utf-8",dataType:"json","async":!0,success:function(n){var t=n.d;if(t.table==="")console.log("No se pudo generar la tabla de solicitudes");else{$("#panelTabla").hide();$("#panelForm").show();const n=`

                            <label>Solicitud: ${t.solicitud.IdSolicitud} </label>

                            <table style="width: 100%!important;" class="table table-bordered table-hover table-sm"
                                id="tableSolicitudes">

                                <thead class="thead-light">

                                    <th scope="col">#</th>
                                    <th scope="col">Equipo</th>
                                    <th scope="col">Odómetro/horómetro</th>
                                    <th scope="col">Lts</th>
                                    <th scope="col">Tipo combustible</th>
                                    <th scope="col">Cincho anterior</th>
                                    <th scope="col">Cincho actual</th>
                                    <th scope="col">Obra</th>
                                    <th scope="col">Litros surtidos</th>
                                    <th scope="col"></th>
                                    <th scope="col"></th>


                                </thead>
                                <tbody>
                                </tbody>
                            </table>
                    `;$("#table_").empty().append(n);$("#tableSolicitudes tbody").empty().append(t.Table)}},error:function(n,t){console.log(t+": "+n.responseText)}})},subirImagenes:(n,t)=>{registroAprobacion.idDetalleSolicitud=n,registroAprobacion.fecha=t,$("#panelImagenes").modal("show"),imagenes.mostrarImagenes(n,null)},accionesBotones:()=>{$(".file-fotografia1").on("change",function(n){n.preventDefault();let t;(t=this.files[0])&&imagenes.guardarImagenCombustible(registroAprobacion.idDetalleSolicitud,registroAprobacion.fecha,1,t,"fotografiaSolicitudCombustible1")});$(".file-fotografia2").on("change",function(n){n.preventDefault();let t;(t=this.files[0])&&imagenes.guardarImagenCombustible(registroAprobacion.idDetalleSolicitud,registroAprobacion.fecha,2,t,"fotografiaSolicitudCombustible2")});$(".file-fotografia3").on("change",function(n){n.preventDefault();let t;(t=this.files[0])&&imagenes.guardarImagenCombustible(registroAprobacion.idDetalleSolicitud,registroAprobacion.fecha,3,t,"fotografiaSolicitudCombustible3")});$("#btnCancelarAceptar").on("click",n=>{n.preventDefault();$(".btn-aprobar").attr("disabled",!0);$(".btn-cancelar").attr("disabled",!0);let t={};t.path=window.location.hostname;t.idSolicitud=registroAprobacion.idSolicitud;t.idDetalleSolicitud=registroAprobacion.idDetalleSeleccionado;t.idUsuario=sessionStorage.getItem("idusuario");t=JSON.stringify(t);$.ajax({type:"POST",url:"../pages/Combustibles_Aprobacion.aspx/CancelarEntrega",data:t,contentType:"application/json; charset=utf-8",dataType:"json","async":!0,success:function(n){var t=n.d;$(".btn-aprobar").attr("disabled",!1);$(".btn-cancelar").attr("disabled",!1);t.MensajeError===null?(utils.toast(mensajesAlertas.exitoCancelarSolicitudCombustible,"ok"),registroAprobacion.editarDetalle(registroAprobacion.idSolicitud)):utils.toast(t.MensajeError,"error")},error:function(n,t){console.log(t+": "+n.responseText)}})});$("#btnFinalizarAceptar").on("click",n=>{n.preventDefault();let t={};t.path=window.location.hostname;t.idUsuario=sessionStorage.getItem("idusuario");t.idSolicitud=registroAprobacion.idSeleccionado;t=JSON.stringify(t);$.ajax({type:"POST",url:"../pages/Combustibles_Aprobacion.aspx/Finalizar",data:t,contentType:"application/json; charset=utf-8",dataType:"json","async":!0,success:function(n){var t=n.d;t.CodigoError==0?($("#spnMensajes").html(mensajesAlertas.exitoGuardar),$("#panelMensajes").modal("show"),registroAprobacion.cargarItems()):utils.toast(t.MensajeError,"error")},error:function(n,t){console.log(t+": "+n.responseText);utils.toast(mensajesAlertas.errorGuardar,"error")}})});$("#btnFinalizarIndividualAceptar").on("click",n=>{n.preventDefault();let t={};t.path=window.location.hostname;t.idUsuario=sessionStorage.getItem("idusuario");t.idSolicitud=registroAprobacion.idSolicitud;t.idDetalleSolicitud=registroAprobacion.idDetalleSeleccionado;t=JSON.stringify(t);$.ajax({type:"POST",url:"../pages/Combustibles_Aprobacion.aspx/FinalizarIndividual",data:t,contentType:"application/json; charset=utf-8",dataType:"json","async":!0,success:function(n){var t=n.d;t.CodigoError==0?($("#spnMensajes").html(mensajesAlertas.exitoGuardar),$("#panelMensajes").modal("show"),registroAprobacion.cargarItems(),$("#panelTabla").show(),$("#panelForm").hide()):utils.toast(t.MensajeError,"error")},error:function(n,t){console.log(t+": "+n.responseText);utils.toast(mensajesAlertas.errorGuardar,"error")}})});$(".btnAprobarAceptar").on("click",n=>{n.preventDefault();console.log("aprobar item");$(".btn-aprobar").attr("disabled",!0);let i=-1;if(parseInt(registroAprobacion.idTipoSolicitud)===2&&(i=$("#comboProveedorCombustible").val(),i==null||parseInt(i)===0)){utils.toast(mensajesAlertas.errorSeleccionarProveedor,"error");return}let t={};t.path=window.location.hostname;t.idSolicitud=registroAprobacion.idSolicitud;t.idDetalleSolicitud=registroAprobacion.idDetalleSolicitud;t.idUsuario=sessionStorage.getItem("idusuario");t.odometro=registroAprobacion.data.odometro;t.litros=registroAprobacion.data.litros;t.horometroEntrega=registroAprobacion.data.horometroEntrega;t.idProveedorCombustible=i;t=JSON.stringify(t);$.ajax({type:"POST",url:"../pages/Combustibles_Aprobacion.aspx/Aprobar",data:t,contentType:"application/json; charset=utf-8",dataType:"json","async":!0,success:function(n){var t=n.d;console.log(t);$(".btn-aprobar").attr("disabled",!1);$("#panelAprobarIndividuales").modal("hide");t.MensajeError===null?(utils.toast(mensajesAlertas.exitoAprobar,"ok"),registroAprobacion.cargarItems(),registroAprobacion.editarDetalle(registroAprobacion.idSolicitud)):utils.toast(t.MensajeError,"error")},error:function(n,t){console.log(t+": "+n.responseText);utils.toast(mensajesAlertas.errorGuardar,"error");$(".btn-entregar").attr("disabled",!1)}})});$("#btnCancelar").on("click",n=>{n.preventDefault(),registroAprobacion.cargarItems(),$("#panelTabla").show(),$("#panelForm").hide()})}};window.addEventListener("load",()=>{registroAprobacion.init(),registroAprobacion.accionesBotones()});